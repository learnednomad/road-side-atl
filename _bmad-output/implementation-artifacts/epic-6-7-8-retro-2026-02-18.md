# Retrospective: Epics 6, 7, 8 — Observations, Referrals, Inspections

**Date:** 2026-02-18
**Epics Reviewed:** Epic 6 (Vehicle Observation & Follow-Up Pipeline), Epic 7 (Referral Growth Engine), Epic 8 (Branded Vehicle Inspection Reports)
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Beel

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Beel (Project Lead)

## Epic Summary & Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 6/6 (100%) |
| Epics Delivered | 3 |
| FRs Covered | FR33, FR44, FR45, FR47, FR53, FR54, FR66, FR67, FR68, FR69, FR70, FR71, FR80 |
| Integration FRs Verified | FR35, FR36, FR37, FR38, FR46 |
| Code Review Issues Found | 67 (27 HIGH, 27 MEDIUM, 13 LOW) |
| Issues Fixed | 54 (all HIGH + MEDIUM) |
| Files Modified in Fix Pass | 37 |
| New Dependencies | 0 |
| Production Incidents | 0 |

### Story Breakdown

| Story | Title | Type | Files Changed |
|-------|-------|------|---------------|
| 6-1 | Observation Schema & Provider Submission | Full build | 16 |
| 6-2 | Follow-Up Notifications & Provider Ops | Verify + harden | 2 |
| 7-1 | Referral Schema & Post-Service SMS | Verify + wire | 2 |
| 7-2 | Referral Tracking & Credits | Feature extension | 12 |
| 8-1 | Inspection Report Schema & Provider Submission | Mixed verify + new | 3 |
| 8-2 | Branded PDF Generation & Email Delivery | Pure verification | 0 |

## Successes

### Product
1. **Brownfield leverage was exceptional.** Story 8.2 required zero code changes. Story 7.1 only modified 2 files. The existing codebase carried the weight.
2. **Three complete feature pipelines delivered in one sprint:** vehicle observations (Front Door 1 → Front Door 2 bridge), referral growth engine, and branded inspection reports.
3. **100% story completion rate** across all 3 epics.

### Technical
1. **JSONB typing pattern** (`.$type<T[]>()`) worked perfectly for observations, inspection findings, and checklist configs — consistent, type-safe, no separate tables needed.
2. **Notification architecture is rock-solid.** Every epic slotted new functions into the same `Promise.allSettled` + fire-and-forget pattern.
3. **Integer math discipline held** — cents for money, basis points for multipliers. No floating-point across 3 epics.
4. **Grouped fix strategy** — 5 non-overlapping fix agents touching 37 files without merge conflicts.

### Quality
1. **Batch adversarial code review** caught 67 issues before production, including dead code (`creditReferralOnFirstBooking` never wired).
2. **TypeScript caught schema change cascade** — `resubmission_requested` addition immediately flagged 3 UI components.
3. **Zero new dependencies** — all 3 epics used existing stack.

## Challenges

### Cross-Story NFR Compliance Drift
`statusCallback` (NFR49) was missing from 4 of 6 SMS notification functions. Each story added its notification independently without checking cross-story NFR compliance. This is a systemic process gap.

**Affected functions:** `sendDelayNotificationSMS`, `sendPreServiceConfirmationSMS`, `sendReferralSMS`, `sendReferralCreditSMS`

### Dead Code / Unwired Integrations
- `creditReferralOnFirstBooking()` existed but was never called in booking completion handlers
- `ReferralCreditSelector` component built but not integrated into `booking-form.tsx`
- `notifyReferralCredit` signature was updated (added email/name params) but call sites not updated

**Root cause:** The gap between "function exists" and "function is called from its intended integration point" is where bugs hide.

### Stale Response Patterns
- Observation submission returned pre-update record instead of re-reading after `followUpSent` toggle
- Inspection email endpoint set `emailedAt` before confirming email actually sent

### Import / Validation Inconsistencies
- `reviews.ts` imported from `"zod"` instead of `"zod/v4"`
- Both observations and inspection-reports routes accepted unbounded `limit` parameters
- Referral `/apply` endpoint returned 404 revealing referral code existence (information leakage)

## Key Insights

1. **Verification stories catch what creation stories miss.** Stories 6.2 and 8.2 were primarily verification and surfaced real gaps. Re-reading existing code with fresh eyes finds problems the original implementer missed.

2. **Cross-cutting concerns need cross-cutting checks.** NFR49 and NFR50 are cross-cutting. Per-story checks miss systemic omissions. Need an NFR compliance sweep after each epic.

3. **"Last mile" wiring is the highest-risk gap.** Functions get written. Components get built. But the integration step gets missed. Every story needs a "wiring verification" step before marking done.

4. **Batch adversarial code review is the right model.** 67 issues found across 6 stories validates simultaneous review. Sequential story-by-story reviews would have missed cross-story patterns.

## Previous Retrospective Follow-Through

**First retrospective** — no previous retro exists for any epic. This establishes the baseline for future retrospectives.

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|------------------|
| 1 | Add NFR compliance sweep to code review checklist | Bob (SM) | Every review includes cross-cutting NFR check (statusCallback, unsubscribe, audit logging) |
| 2 | Add "wiring verification" step to story completion | Bob (SM) | Before marking done, verify all new functions/components are called from integration points |
| 3 | Continue batch code review model | Bob (SM) | Future epics use simultaneous adversarial review across all stories |

### Technical Debt

| # | Item | Priority | Notes |
|---|------|----------|-------|
| 1 | InspectionPreview component orphaned | Low | No customer-facing route. Email URL points to non-existent page. Future scope. |
| 2 | TOCTOU race on redeemReferralCredits | Medium | calculateCreditBalance → update not atomic. Needs DB transaction at scale. |
| 3 | SMS delay mechanism not implemented | Low | REFERRAL_SMS_DELAY_MINUTES=30 constant exists but no queue/scheduler. Fires immediately. |
| 4 | No rate limiting on inspection-reports | Medium | PDF generation is CPU-intensive. Needs rate limiting before production load. |

### Team Agreements

- All new SMS functions include `statusCallback` from day one
- All new email functions include unsubscribe link from day one
- All `logAudit()` calls are awaited (not fire-and-forget)
- All pagination endpoints enforce `Math.min(limit, 100)` with NaN protection
- No function ships without being wired into its caller

## Next Epic Preparation: Epic 5 (Financial Reporting & Analytics)

### Stories Planned
- 5-1: Admin Financial Dashboard & Revenue Analytics (FR24, FR72)
- 5-2: Provider Earnings View (FR42)
- 5-3: Admin 1099 Export & Operations Management (FR82, FR78, FR79, FR81)

### Dependencies
- Epic 3 (Payment Operations & Commission) — done
- No dependency on Epics 6, 7, or 8

### Preparation Tasks

| Task | Owner | Priority |
|------|-------|----------|
| Verify/install Recharts | Charlie | Critical |
| Create encryption utility (AES-256) for taxId | Charlie | Critical |
| Create financial-reports route module shell | Charlie | High |
| Register route in server/api/index.ts | Charlie | High |
| Recharts API patterns study | Elena | Medium |
| Financial seed data (bookings, payments, payouts) | Dana | High |

### Significant Discoveries
No architectural assumptions invalidated. Epic 5's plan remains sound. Financial data model from Epic 3 is solid.

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | Pass | All HIGH+MEDIUM issues fixed. TS compiles clean. |
| Deployment | Pending merge | Code on `feat/epic-2-storm-mode-and-pricing-admin`, not yet merged to main. |
| Stakeholder Acceptance | Pending | Beel to review. |
| Technical Health | Solid | 13 LOW items documented, none blocking. |
| Unresolved Blockers | None | — |

## Next Steps

1. Review this retrospective summary
2. Complete preparation tasks for Epic 5
3. Track action items in next sprint planning
4. Begin Epic 5 story creation when prep is done
