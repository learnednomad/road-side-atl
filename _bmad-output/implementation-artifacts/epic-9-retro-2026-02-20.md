# Retrospective: Epic 9 — B2B Account Management

**Date:** 2026-02-20
**Epic Reviewed:** Epic 9 (B2B Account Management — Phase 2)
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Beel

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Beel (Project Lead)

## Epic Summary & Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 2/2 (100%) |
| FRs Covered | FR56, FR57, FR58, FR59, FR60, FR61, FR62, FR63 |
| Code Review Findings | 13 (5 HIGH, 6 MEDIUM, 2 LOW) |
| All Findings Fixed | Yes |
| New Files | 4 |
| Modified Files | 21 |
| New Dependencies | 0 |
| Production Incidents | 0 |
| Technical Debt Incurred | 0 new |

### Story Breakdown

| Story | Title | Type | New Files | Modified Files |
|-------|-------|------|-----------|----------------|
| 9-1 | B2B Account & Contract Management | Full build | 4 | 11 |
| 9-2 | B2B Invoicing & Billing | Pure extension | 0 | 10 |

## Successes

### Architecture & Planning
1. **Brownfield architecture planning paid off massively.** The `tenantId` pre-positioning across 6 tables (designed during architecture phase) meant B2B isolation worked out of the box. Financial reports B2B/B2C filtering and auto-dispatch B2B priority required zero changes.
2. **Story 9.1 leveraged 8 existing infrastructure components** without modification: financial reports B2B filtering, auto-dispatch priority, auth middleware, audit logging, rate limiting, admin layout, invoices table, WebSocket broadcast.
3. **Story 9.2 required zero new files** — purest brownfield extension in the entire project. Existing invoice schema, number generator, and route module were simply extended.
4. **9 epics, 27 stories, 83 FRs, 50 NFRs — zero architectural pivots.** The 6-file feature pattern, 127 implementation rules, and integer math discipline (cents + basis points) held across the entire project.

### Technical
1. **JSONB typing pattern** (`.$type<T>()`) continued to work cleanly for B2B billing addresses and contract configurations.
2. **Zero new npm dependencies** — entire B2B system built with existing stack.
3. **Application-level tenant isolation** (NFR27) confirmed working at scale design — no schema-level changes needed as B2B accounts grow from 3 to 50+.

### Quality
1. **Batch adversarial code review** caught 13 issues across 2 stories, including a security vulnerability (XSS in email template) and an unwired notification function.
2. **Code review remains the highest-value quality gate** in absence of automated tests.

## Challenges

### Notification Wiring Gap (Recurring)
Story 9.1 shipped to code review with `notifyB2bServiceDispatched()` built but wired to the wrong endpoint — the booking creation endpoint called generic `notifyBookingCreated` instead. This is the **same class of bug** identified in the Epic 6-7-8 retrospective. Action item #2 ("add wiring verification step") was not addressed.

**Root cause:** Process relies on developer memory instead of structural enforcement.

### Constants/Enum Synchronization (New Pattern)
Story 9.2 added "overdue" to `invoiceStatusEnum` in the database but forgot to update the `INVOICE_STATUSES` constant in `lib/constants.ts`. Schema and constants drifted apart.

**Root cause:** No automated or checklist-driven verification that enum changes propagate to constants.

### Email Template XSS (Security)
Story 9.2's invoice email template injected user-provided company names and service descriptions into HTML without sanitization. `escapeHtml()` was missing. **Unknown blast radius** — 8-10 other email functions across Epics 1-8 may have the same gap.

**Root cause:** No security-focused check in the code review process for HTML template sanitization.

### Retro Action Item Follow-Through (Systemic)
From the Epic 6-7-8 retrospective:
- Action items: 1/3 completed (batch review model only)
- Technical debt items: 0/4 addressed
- Team agreements: Partially followed (unsubscribe links yes, but statusCallback and wiring verification no)

**Root cause:** Action items documented in markdown but not tracked as real work with owners and deadlines.

## Key Insights

1. **"Wire by force, not by memory."** Notification wiring, enum/constant sync, and email XSS are all the same class of bug: things that exist but aren't connected to their integration points. Structural enforcement (checklists, review gates) must replace developer recall.

2. **Forward-looking architecture compounds massively.** The tenantId pre-positioning decision, made during architecture phase, saved an entire story's worth of work in Epic 9. Design decisions that anticipate future needs pay exponential dividends.

3. **Retro commitments must be tracked work.** Markdown documents don't drive behavior. Action items without specific owners, deadlines, and verification mechanisms are aspirational, not operational.

4. **Batch adversarial code review is non-negotiable.** 13 findings across 2 stories — including security — validates the model. Without it, XSS and unwired notifications would have shipped.

5. **Brownfield consistency is a superpower.** 27 stories following the same 6-file pattern, the same 127 rules, the same integer math discipline. Consistency compounds into velocity.

## Previous Retrospective Follow-Through

**Source:** `epic-6-7-8-retro-2026-02-18.md`

### Action Items

| # | Action | Status | Evidence |
|---|--------|--------|----------|
| 1 | Add NFR compliance sweep to code review checklist | ⏳ Partial | Reviews happened but sweep not formalized. Caught unsubscribe links, missed XSS. |
| 2 | Add "wiring verification" step to story completion | ❌ Not Addressed | Story 9.1 shipped with unwired B2B notification. Caught in code review, not prevented. |
| 3 | Continue batch code review model | ✅ Completed | Both stories had thorough adversarial reviews. 13 findings caught. |

### Technical Debt

| # | Item | Status | Impact on Epic 9 |
|---|------|--------|-------------------|
| 1 | InspectionPreview component orphaned | ❌ Not addressed | No impact — consciously deferred |
| 2 | TOCTOU race on redeemReferralCredits | ❌ Not addressed | No impact — promoted to tracked work |
| 3 | SMS delay mechanism not implemented | ❌ Not addressed | No impact — consciously deferred |
| 4 | No rate limiting on inspection-reports | ❌ Not addressed | No impact — promoted to tracked work |

### Team Agreements

| Agreement | Status |
|-----------|--------|
| All new SMS functions include statusCallback | ⚠️ Unverified for B2B notifications |
| All new email functions include unsubscribe link | ✅ Both stories include unsubscribe |
| All logAudit() calls are awaited | ⚠️ Unverified |
| All pagination endpoints enforce Math.min(limit, 100) | ⚠️ Unverified |
| No function ships without being wired into its caller | ❌ Failed then caught in review |

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|------------------|
| 1 | Create mandatory "Integration Wiring Checklist" for story completion | Bob (SM) + Charlie (content) | Every story file includes checklist: each new function lists its call site, each new component lists its import site. Code review fails if unwired. |
| 2 | Formalize code review checklist with structural checks | Bob (SM) + Charlie (content) | Checklist includes: (a) pgEnum/constant sync, (b) escapeHtml on HTML templates, (c) verified call sites, (d) NFR compliance sweep |
| 3 | Wire retro action items to tracked work | Bob (SM) | Every retro action item becomes tracked task with owner, deadline, verification. Reviewed at next epic kickoff. |

### Security Audit

| # | Action | Owner | Priority |
|---|--------|-------|----------|
| 4 | Retroactive email template XSS audit across all 9 epics | Charlie (Senior Dev) | **HIGH** |

### Consistency Audits

| # | Action | Owner | Priority |
|---|--------|-------|----------|
| 5 | Enum/constant synchronization audit across all schemas | Elena (Junior Dev) | MEDIUM |
| 6 | Notification wiring audit across all 9 epics | Dana (QA Engineer) | MEDIUM |

### Technical Debt (Promoted)

| # | Item | Owner | Priority |
|---|------|-------|----------|
| 7 | Fix TOCTOU race on redeemReferralCredits — wrap in DB transaction | Charlie (Senior Dev) | MEDIUM |
| 8 | Add rate limiting to inspection-reports PDF endpoints | Charlie (Senior Dev) | MEDIUM |

### Technical Debt (Consciously Deferred)

| # | Item | Priority | Rationale |
|---|------|----------|-----------|
| D1 | InspectionPreview component orphaned | LOW | No customer-facing route. Defer until inspection reports feature is user-tested. |
| D2 | SMS delay mechanism not implemented | LOW | REFERRAL_SMS_DELAY_MINUTES constant exists but fires immediately. Defer until queue/scheduler infrastructure justified. |

### Team Agreements (Updated)

All previous agreements carry forward, plus:
- All email templates must use `escapeHtml()` on any user-provided content — no exceptions
- Every `pgEnum` change must be accompanied by a corresponding `lib/constants.ts` update in the same commit
- Retro action items are tracked tasks, not markdown suggestions. Reviewed at next epic kickoff.

### Critical Path

| # | Item | Owner | Must Complete Before |
|---|------|-------|---------------------|
| 1 | B2B invoicing edge case verification (4 checks) | Dana + Charlie | Epic 9 can be called production-ready |
| 2 | Email template XSS audit | Charlie | Any deployment to production |
| 3 | Merge feature branch to main | Beel (decision) | Production deployment |
| 4 | Stakeholder review of Epic 9 | Alice + Beel | Production deployment |

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | ⚠️ Needs verification | 4 targeted B2B invoicing checks required |
| Deployment | ⚠️ Not deployed | All code on feature branch, no merge timeline |
| Stakeholder Acceptance | ⚠️ Pending | No stakeholder review yet |
| Technical Health | ✅ Solid | Patterns held, no fragile areas |
| Unresolved Blockers | ✅ None | All issues captured as action items |

## Project-Wide Reflection

Epic 9 closes out the entire 9-epic roadmap:
- **27 stories** delivered across **9 epics**
- **83 functional requirements** covered
- **50 non-functional requirements** addressed
- **Zero architectural pivots** — the brownfield architecture held
- **Zero production incidents** across the project
- **Integer math discipline** (cents + basis points) maintained throughout — no floating-point financial bugs
- **6-file feature pattern** and **127 implementation rules** followed consistently

The brownfield strategy — defining architecture upfront, pre-positioning infrastructure (tenantId, invoice schema), and enforcing consistency through documented patterns — proved to be the project's greatest strength.

## Next Steps

1. Execute B2B verification (Critical path — Dana + Charlie)
2. Execute security audit — email template XSS (HIGH — Charlie)
3. Execute consistency audits — enum/constant sync (Elena), notification wiring (Dana)
4. Fix promoted debt — TOCTOU race + rate limiting (Charlie)
5. Formalize process improvements — wiring checklist, review checklist, retro tracking (Bob)
6. Plan deployment — merge feature branch to main when verification complete
7. Schedule stakeholder review — demo Epic 9 B2B capabilities
