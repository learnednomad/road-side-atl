# Epic 2 Retrospective: Dynamic Pricing & Storm Mode

**Date:** 2026-02-20
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 2 - Dynamic Pricing & Storm Mode
**Status:** Complete (3/3 stories done)

## Team Participants

- Bob (Scrum Master) -- Facilitator
- Alice (Product Owner) -- Business perspective
- Charlie (Senior Dev) -- Technical depth
- Dana (QA Engineer) -- Quality and testing
- Elena (Junior Dev) -- Fresh perspective
- Beel (Project Lead) -- Strategic direction

## Epic Summary & Metrics

| Metric | Value |
|---|---|
| Stories Completed | 3/3 (100%) |
| Tasks Completed | 19/20 (95%) -- 1 deferred |
| Code Review Issues Found | 15 total |
| Code Review Issues Fixed | 15/15 (100%) |
| TypeScript Errors at Completion | 0 per story |
| Blockers Encountered | 2 |
| Technical Debt Items | 2 |
| Production Incidents | 0 |
| New Schema Tables | 1 (time_block_configs) |
| New Migrations | 2 (0011, 0012) |
| Files Created | 9 |
| Files Modified | ~25 |
| ACs Delivered | 9/10 (1 deferred to Story 4.2) |

### Stories Delivered

1. **Story 2.1: Time-Block Pricing Schema & Engine** -- Created `time_block_configs` table, centralized pricing engine with priority-based resolution, overnight block handling, 6 seed rows, admin API route. Code review: 1H/4M/2L -- all fixed.

2. **Story 2.2: Storm Mode Activation & Templates** -- Added Storm Mode API endpoints (status/activate/deactivate), StormModeToggle component, WebSocket events, sidebar navigation. Zero debug issues. Code review: 2M/4L -- all fixed. Used db.transaction() for race condition prevention.

3. **Story 2.3: Admin Pricing Configuration & Booking Override** -- Added priceOverrideCents/priceOverrideReason to bookings schema, PricingConfigTable component, BookingPriceOverride component with clear/pre-populate. Task 3.4 (payout recalculation) deferred. AC #4 deferred to Story 4.2. Code review: 2H/4M/2L -- all fixed.

## What Went Well

1. **Elegant priority-based pricing architecture** -- Storm Mode works by design, not by special-casing. Activating Storm Mode is literally toggling `isActive` on a high-priority row. The pricing engine's priority resolution handles everything automatically.

2. **Clean story progression** -- 2.1 built the engine, 2.2 added Storm Mode on top, 2.3 added config UI and overrides. Each story had clear boundaries and natural dependencies. No scope creep between stories.

3. **100% code review fix rate** -- Every issue found in code review was resolved before the story was marked done. Reviews caught real issues: missing response fields, race conditions, input validation gaps.

4. **Zero TypeScript errors at completion** -- Every story compiled cleanly. The type system caught problems early.

5. **Integer math discipline** -- Three stories, zero floating-point slips. Basis points (10000 = 1.0x) for multipliers, cents for money. Convention held firm throughout.

6. **Fire-and-forget convention** -- Audit logging and WebSocket broadcasts consistently used without await, following established patterns.

## What Didn't Go Well

1. **Spec accuracy issues (2/3 stories)** -- Story 2.1's spec claimed `pricing.update_block` and `pricing.toggle_storm_mode` audit actions already existed -- they didn't, requiring manual addition. Story 2.3's AC #4 was a customer-facing requirement bundled into an admin story, requiring deferral to Story 4.2.

2. **Payout recalculation gap** -- Task 3.4 in Story 2.3 (payout recalculation on price override) was deferred because `createPayoutIfEligible()` uses `confirmedPayment.amount` rather than booking price. Admin price overrides don't update provider payouts until Epic 3 fixes this.

3. **Missing API response fields** -- Found in 2/3 code reviews. Story 2.1 was missing `pricingBreakdown` in booking response. Story 2.3 was missing `previousOverrideCents` in audit details. Specs didn't fully specify response shapes.

4. **Local DB unavailability** -- Story 2.3's migration (0012) couldn't be tested locally because no local PostgreSQL instance was running. Migration correctness relied on Docker deployment.

## Key Insights

1. **Priority-based systems are powerful** -- One resolution mechanism (highest priority wins) handles both time-block pricing and Storm Mode. This pattern is extensible for future pricing features without engine modifications.

2. **Story specs must be verified against actual codebase** -- 2/3 stories had incorrect assertions about what existed. Devs should verify spec claims before coding begins.

3. **API response shapes should be explicitly specified** -- Missing fields were caught only during code review. Including expected response fields in story tasks would prevent this.

4. **Hono route ordering is critical** -- Static routes (e.g., `/storm-mode/status`) must be registered BEFORE parameterized routes (e.g., `/:id`) to prevent Hono from matching path segments as parameters.

5. **Progressive story design works** -- Each story building on the previous one's foundation led to clean, predictable development with decreasing debug issues (2.1 had issues, 2.2 had zero, 2.3 had minimal).

## Previous Retrospective Follow-Through

This is the first retrospective for the project. No prior commitments to track.

## Action Items

### Process Improvements

1. **Verify story specs against actual codebase before development starts**
   - Owner: Dev (whoever picks up the story)
   - Success criteria: Dev notes confirm spec claims were verified; discrepancies reported before coding
   - Deadline: Starting with Epic 3 Story 3.1

2. **Explicitly specify API response shapes in story ACs or tasks**
   - Owner: SM (during story creation)
   - Success criteria: Each endpoint task includes expected response fields
   - Deadline: Starting with Epic 3 story creation

3. **Document Hono route ordering constraint in project context**
   - Owner: Charlie (Senior Dev)
   - Success criteria: Pattern documented in project-context.md
   - Deadline: Before Epic 3 starts

### Technical Debt

1. **Payout recalculation on booking price override (Task 3.4)**
   - Priority: HIGH
   - Impact: Admin price overrides don't update provider payouts
   - Owner: Dev assigned to Story 3.3 (Batch Payouts & Refunds)
   - Note: `createPayoutIfEligible()` needs refactor to support recalculation

2. **Transparent pricing display (AC #4 from Story 2.3)**
   - Priority: MEDIUM
   - Impact: Customers don't see pricing breakdown before confirming
   - Owner: Dev assigned to Story 4.2 (Transparent Pricing Display)

### Team Agreements

- All multipliers and money values in integer math (basis points / cents) -- no exceptions
- Fire-and-forget for audit logging and WebSocket broadcasts (established convention)
- Code reviews continue at current depth (5-7 findings per story is healthy)
- Static routes always registered before parameterized routes in Hono
- AuthEnv type declared locally in each route file (not imported)

## Next Epic Preview: Epic 3 - Payment Operations & Tiered Commission

### Dependencies on Epic 2
- Basis-point math convention for commission calculations
- Pricing engine and time-block system as pricing foundation
- Deferred Task 3.4 feeds directly into Story 3.3's payout rework

### Preparation Needed
- [ ] Review `createPayoutIfEligible()` in `payout-calculator.ts` for refactoring needs
- [ ] Verify Resend email integration patterns for receipt generation
- [ ] Plan `commissionRate` column addition to services table (same basis-point convention)

### Risks
- Payout system refactoring in Story 3.3 is the most complex work -- needs careful planning
- Financial operations (refunds, clawbacks) require idempotency keys (NFR34)
- Email receipt templates need design before Story 3.2

### Epic Update Required: NO
Nothing from Epic 2 fundamentally changes the Epic 3 plan. The deferred Task 3.4 is naturally absorbed by Story 3.3's payout system rework.

## Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Testing & Quality | GOOD | All stories pass TypeScript. Playwright MCP testing completed. NaN% bug found and fixed. |
| Deployment | GOOD | Running in Docker. Migrations applied via docker-entrypoint. |
| Technical Health | GOOD | Pricing engine well-architected. 2 deferred items tracked. |
| Unresolved Blockers | NONE | No blockers preventing Epic 3 start. |

## Final Summary

Epic 2 delivered a well-architected dynamic pricing system with Storm Mode capabilities. The priority-based resolution pattern is the standout architectural decision -- it enables extensible pricing without engine modifications. Code quality was consistently high with 100% code review fix rates. The two deferred items (payout recalculation and transparent pricing display) have clear homes in future epics. The team is well-positioned for Epic 3's payment operations work.

---

*Retrospective conducted: 2026-02-20*
*First retrospective for the project -- baseline established*
